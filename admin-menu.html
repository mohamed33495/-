<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#334155">
    <title>القائمة | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>

<body class="bg-slate-800 text-white h-screen flex flex-col overflow-hidden">

    <div class="flex-1 overflow-y-auto pb-24 px-6 pt-10">

        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-4">
                <div class="relative">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=3b82f6&color=fff"
                        class="w-16 h-16 rounded-full border-4 border-slate-600 shadow-xl">
                    <div class="absolute bottom-0 right-0 bg-green-500 w-4 h-4 rounded-full border-2 border-slate-800">
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-bold">المشرف خالد</h2>
                    <p class="text-slate-400 text-xs">مدير عمليات</p>
                </div>
            </div>

            <!-- Notification Bell -->
            <button onclick="toggleNotifications()"
                class="relative w-12 h-12 rounded-2xl bg-slate-700/50 border border-slate-600 flex items-center justify-center text-slate-300 hover:bg-slate-700 hover:text-white transition active:scale-95">
                <i class="fa-solid fa-bell text-xl"></i>
                <span id="notifBadge"
                    class="absolute top-3 right-3 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-slate-700 hidden"></span>
            </button>
        </div>

        <div class="space-y-3">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">الإدارة</p>

            <a href="admin-requests.html"
                class="flex items-center gap-4 p-4 rounded-2xl bg-slate-700/50 border border-slate-600 hover:bg-slate-700 transition">
                <div class="w-10 h-10 rounded-full bg-yellow-500/20 text-yellow-400 flex items-center justify-center"><i
                        class="fa-solid fa-user-clock"></i></div>
                <span class="font-bold text-sm">طلبات السائقين</span>
            </a>

            <a href="#"
                class="flex items-center gap-4 p-4 rounded-2xl bg-slate-700/50 border border-slate-600 hover:bg-slate-700 transition">
                <div class="w-10 h-10 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center"><i
                        class="fa-solid fa-warehouse"></i></div>
                <span class="font-bold text-sm">إعدادات المخزون</span>
            </a>

            <a href="#"
                class="flex items-center gap-4 p-4 rounded-2xl bg-slate-700/50 border border-slate-600 hover:bg-slate-700 transition">
                <div class="w-10 h-10 rounded-full bg-orange-500/20 text-orange-400 flex items-center justify-center"><i
                        class="fa-solid fa-users"></i></div>
                <span class="font-bold text-sm">قائمة العملاء (CRM)</span>
            </a>

            <button onclick="window.location.href='login.html?logout=true'"
                class="w-full flex items-center gap-4 p-4 rounded-2xl bg-red-500/10 border border-red-500/20 hover:bg-red-500/20 transition text-red-400 mt-6">
                <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center"><i
                        class="fa-solid fa-power-off"></i></div>
                <span class="font-bold text-sm">تسجيل الخروج</span>
            </button>
        </div>

    </div>

    <nav
        class="fixed bottom-6 left-4 right-4 bg-slate-800/95 backdrop-blur-xl border border-white/10 shadow-2xl rounded-2xl flex justify-around items-center py-3 z-50">
        <a href="admin-panel.html"
            class="flex flex-col items-center gap-1 text-slate-400 hover:text-white transition group"><i
                class="fa-solid fa-gauge-high text-xl group-active:scale-90 transition"></i></a>
        <a href="admin-shipments.html"
            class="flex flex-col items-center gap-1 text-slate-400 hover:text-white transition group"><i
                class="fa-solid fa-satellite-dish text-xl group-active:scale-90 transition"></i></a>
        <div class="relative -top-8"><button
                class="bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/40 border-4 border-gray-100 transform active:scale-90 transition"><i
                    class="fa-solid fa-plus text-2xl"></i></button></div>
        <a href="admin-drivers.html"
            class="flex flex-col items-center gap-1 text-slate-400 hover:text-white transition group"><i
                class="fa-solid fa-motorcycle text-xl group-active:scale-90 transition"></i></a>
        <a href="#" class="flex flex-col items-center gap-1 text-white transition group relative">
            <i class="fa-solid fa-bars text-xl"></i>
            <span class="absolute -bottom-2 w-1 h-1 bg-white rounded-full"></span>
        </a>
    </nav>


    <!-- Notifications Modal -->
    <div id="notifModal"
        class="fixed inset-0 bg-black/60 z-[70] hidden flex flex-col justify-start pt-20 backdrop-blur-sm px-4"
        onclick="if(event.target === this) toggleNotifications()">
        <div class="bg-white w-full rounded-2xl shadow-2xl overflow-hidden animate-slide-down">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-bell text-orange-500"></i> الإشعارات
                </h3>
                <button onclick="toggleNotifications()"
                    class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 hover:bg-gray-300 transition"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>

            <div id="notifList" class="max-h-[60vh] overflow-y-auto p-2 space-y-2">
                <div class="text-center py-10 opacity-60">
                    <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                    <p class="text-slate-500 text-sm">جاري التحميل...</p>
                </div>
            </div>

            <div class="bg-gray-50 p-2 text-center">
                <button onclick="toggleNotifications()"
                    class="text-xs text-blue-500 font-bold hover:underline">إغلاق</button>
            </div>
        </div>
    </div>

    <script>
        // Check for notifications every minute
        setInterval(fetchNotifications, 60000);
        document.addEventListener('DOMContentLoaded', fetchNotifications);

        async function fetchNotifications() {
            try {
                const res = await fetch('http://localhost:3000/api/admin/notifications');
                const data = await res.json();

                if (data.success) {
                    const { drivers, shipments, transactions } = data.notifications;
                    const total = drivers.length + shipments.length + transactions.length;

                    // Update Badge
                    const badge = document.getElementById('notifBadge');
                    if (total > 0) {
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }

                    // Render List
                    renderNotifications(drivers, shipments, transactions);
                }
            } catch (e) {
                console.error('Notif Error', e);
            }
        }

        function renderNotifications(drivers, shipments, transactions) {
            const container = document.getElementById('notifList');
            let html = '';

            if (drivers.length + shipments.length + transactions.length === 0) {
                container.innerHTML = '<div class="text-center py-8 opacity-50"><i class="fa-regular fa-bell-slash text-3xl mb-2 text-gray-400"></i><p class="text-xs text-gray-500">لا توجد إشعارات جديدة</p></div>';
                return;
            }

            // Pending Drivers
            drivers.forEach(d => {
                html += `
                <a href="admin-requests.html" class="block bg-blue-50 p-3 rounded-xl border border-blue-100 hover:bg-blue-100 transition">
                    <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-200 text-blue-600 flex items-center justify-center shrink-0"><i class="fa-solid fa-user-plus text-xs"></i></div>
                        <div>
                            <p class="text-xs font-bold text-gray-800">طلب تسجيل سائق جديد</p>
                            <p class="text-[10px] text-gray-500">${d.full_name}</p>
                            <span class="text-[9px] text-gray-400">${new Date(d.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                    </div>
                </a>`;
            });

            // New Shipments
            shipments.forEach(s => {
                html += `
                <a href="admin-shipments.html" class="block bg-purple-50 p-3 rounded-xl border border-purple-100 hover:bg-purple-100 transition">
                    <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-full bg-purple-200 text-purple-600 flex items-center justify-center shrink-0"><i class="fa-solid fa-box text-xs"></i></div>
                        <div>
                            <p class="text-xs font-bold text-gray-800">شحنة جديدة #${s.shipment_id}</p>
                            <p class="text-[10px] text-gray-500">Status: ${s.status}</p>
                            <span class="text-[9px] text-gray-400">${new Date(s.creation_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                    </div>
                </a>`;
            });

            // Transactions
            transactions.forEach(t => {
                html += `
                <a href="#" class="block bg-green-50 p-3 rounded-xl border border-green-100 hover:bg-green-100 transition">
                    <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-full bg-green-200 text-green-600 flex items-center justify-center shrink-0"><i class="fa-solid fa-money-bill text-xs"></i></div>
                        <div>
                            <p class="text-xs font-bold text-gray-800">معاملة مالية $${t.amount}</p>
                            <span class="text-[9px] text-gray-400">${new Date(t.transaction_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                    </div>
                </a>`;
            });

            container.innerHTML = html;
        }

        function toggleNotifications() {
            const modal = document.getElementById('notifModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                fetchNotifications(); // Refresh on open
            } else {
                modal.classList.add('hidden');
            }
        }
    </script>
    <style>
        @keyframes slide-down {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-slide-down {
            animation: slide-down 0.2s ease-out forwards;
        }
    </style>
</body>

</html>